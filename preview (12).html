<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ULTRABLOCK: PRO MAX (Harder!)</title>
<style>
body {
    margin: 0;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: monospace;
    color: white;
}
.game-container {
    position: relative;
}
canvas {
    background: #111;
    border: 4px solid red;
    box-shadow: 0 0 30px red;
}
#game-over-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}
#game-over-screen h1 {
    color: red;
    font-size: 3em;
}
#game-over-screen p {
    font-size: 1.5em;
}
#game-over-screen button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1em;
    cursor: pointer;
    background: red;
    color: white;
    border: none;
    box-shadow: 0 0 10px red;
}
</style>
</head>
<body>
<div class="game-container">
    <canvas id="game" width="400" height="600"></canvas>
    <div id="game-over-screen">
        <h1>GAME OVER</h1>
        <p>You fell into the void!</p>
        <button onclick="restartGame()">Try Again</button>
    </div>
</div>
<script>
    /* ================= CORE ================= */
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const gameOverScreen = document.getElementById("game-over-screen");
    let keys = {};
    let frame = 0;
    let gameOver = false;
    let stage = 0;
    let platforms = []; // Global platform array
    let fallingBlocks = []; // Array for new falling blocks
    let lasers = []; // Array for new lasers

    document.addEventListener("keydown", (e) => keys[e.key] = true);
    document.addEventListener("keyup", (e) => keys[e.key] = false);

    // Function to show the Game Over screen
    function showGameOver(message) {
        gameOver = true;
        document.getElementById('game-over-screen').style.display = 'flex';
        document.querySelector('#game-over-screen p').textContent = message;
    }

    // Function to restart the game
    function restartGame() {
        gameOver = false;
        gameOverScreen.style.display = 'none';
        // Reset all game state variables here
        player.x = canvas.width / 2;
        player.y = canvas.height - 50;
        player.vx = 0;
        player.vy = 0;
        platforms = [];
        fallingBlocks = [];
        lasers = [];
        frame = 0;
        stage = 0;
        initPlatforms();
        gameLoop();
    }

    /* ================= PLAYER ================= */
    const player = {
        x: canvas.width / 2,
        y: canvas.height - 50,
        width: 20,
        height: 20,
        vx: 0,
        vy: 0,
        speed: 4,
        jumpPower: -10,
        gravity: 0.5,
        canJump: false,
        draw() {
            ctx.fillStyle = "cyan";
            ctx.fillRect(this.x, this.y, this.width, this.height);
        },
        update() {
            if (gameOver) return;

            // Movement
            if (keys["ArrowLeft"] || keys["a"]) this.vx = -this.speed;
            else if (keys["ArrowRight"] || keys["d"]) this.vx = this.speed;
            else this.vx = 0;

            // Jump
            if ((keys["ArrowUp"] || keys["w"] || keys[" "]) && this.canJump) {
                this.vy = this.jumpPower;
                this.canJump = false;
            }

            // Apply gravity and move
            this.vy += this.gravity;
            this.x += this.vx;
            this.y += this.vy;

            // Boundary checks
            if (this.x < 0) this.x = 0;
            if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;

            // Check if fallen off the bottom
            if (this.y > canvas.height) {
                showGameOver("You fell into the void!");
            }
        }
    };

    /* ================= PLATFORMS & OBSTACLES ================= */
    function initPlatforms() {
        // Initial safe platform
        platforms.push({ x: 0, y: canvas.height - 20, width: canvas.width, height: 20, color: '#333' });
        // Add starting platforms
        platforms.push({ x: 50, y: canvas.height - 100, width: 100, height: 15, color: 'white' });
        platforms.push({ x: 250, y: canvas.height - 200, width: 100, height: 15, color: 'white' });
        platforms.push({ x: 150, y: canvas.height - 300, width: 100, height: 15, color: 'white' });
    }

    function drawPlatforms() {
        platforms.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.width, p.height);
        });
        fallingBlocks.forEach(b => {
            ctx.fillStyle = b.color;
            ctx.fillRect(b.x, b.y, b.width, b.height);
        });
        lasers.forEach(l => {
            ctx.fillStyle = l.color;
            ctx.fillRect(l.x, l.y, l.width, l.height);
        });
    }

    function updatePlatforms() {
        // Handle falling blocks movement and removal
        fallingBlocks.forEach((block, index) => {
            block.y += block.vy;
            if (block.y > canvas.height) {
                fallingBlocks.splice(index, 1);
            }
        });

        // Spawn new falling blocks periodically
        if (frame % 120 === 0 && !gameOver) { // Spawn a new block every 2 seconds (60 frames/sec)
            const blockWidth = 60;
            fallingBlocks.push({
                x: Math.random() * (canvas.width - blockWidth),
                y: -50, // Start above the canvas
                width: blockWidth,
                height: 20,
                color: 'orange', // Different color for falling blocks
                vy: 2 + Math.random() * 2 // Random falling speed
            });
        }

        // Spawn lasers periodically
        if (frame % 300 === 0 && frame > 0 && !gameOver) { // Spawn a laser every 5 seconds
            const laserHeight = 5;
            lasers.push({
                x: 0,
                y: Math.random() * (canvas.height - 100) + 50, // Random vertical position
                width: canvas.width,
                height: laserHeight,
                color: 'lime', // Bright green laser color
                duration: 90, // Active for 1.5 seconds
                active: true
            });
        }
        
        // Update lasers
        lasers.forEach((laser, index) => {
            if (laser.active) {
                laser.duration--;
                if (laser.duration <= 0) {
                    lasers.splice(index, 1); // Remove laser after duration
                }
            }
        });
    }

    /* ================= COLLISION DETECTION ================= */
    function checkCollisions() {
        player.canJump = false;
        let onPlatform = false;

        // Check player with static platforms
        platforms.forEach(p => {
            if (isColliding(player, p)) {
                handlePlatformCollision(player, p);
                onPlatform = true;
            }
        });

        // Check player with falling blocks
        fallingBlocks.forEach(b => {
             if (isColliding(player, b)) {
                handlePlatformCollision(player, b);
                onPlatform = true;
            }
        });

        // Check player with lasers
        lasers.forEach(l => {
            if (l.active && isColliding(player, l)) {
                showGameOver("You were zapped by a laser!");
            }
        });

        if (onPlatform) {
            player.canJump = true;
        }
    }

    // AABB collision detection helper
    function isColliding(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    // Handles vertical collision resolution for platforms
    function handlePlatformCollision(player, platform) {
        // Only handle collision if falling down onto a platform
        if (player.vy > 0 && player.y + player.height > platform.y && player.y < platform.y + platform.height) {
            player.y = platform.y - player.height;
            player.vy = 0;
            player.canJump = true;
        }
    }


    /* ================= GAME LOOP ================= */
    function gameLoop() {
        if (gameOver) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        frame++;

        player.update();
        updatePlatforms();
        checkCollisions();
        
        drawPlatforms();
        player.draw();
        
        // Display score/stage (optional)
        ctx.fillStyle = 'white';
        ctx.font = '16px monospace';
        ctx.fillText(`Frame: ${frame}`, 10, 20);

        requestAnimationFrame(gameLoop);
    }

    // Start the game
    initPlatforms();
    gameLoop();
</script>
</body>
</html>
